{% extends "fiche_famille/famille.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load embed %}

{% block styles %}
    {{ block.super }}

    <style>
        .info-box-content-inline {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .info-box-small-text {
            font-size: 10px;
            line-height: 1.1;
            max-width: 120px;
            display: flex;
            align-items: flex-end;
        }
    </style>

{% endblock styles %}



{% block detail_famille %}
    <div class="col-md-9">

        {# Caractéristiques #}
        {% embed 'core/box.html' %}
            {% block box_theme %}card-outline card-lightblue{% endblock %}
            {% block box_titre %}Composition de la famille{% endblock %}
            {% block box_outils %}
                <a type="button" class="btn btn-success btn-xs" style="margin-right: 10px;" title="Ajouter un individu" href="{% url 'individu_ajouter' idfamille=idfamille %}"><i class="fa fa-plus"></i> Ajouter</a>
            {% endblock %}
            {% block card_body_classe %}
                p-0
            {% endblock %}
            {% block box_contenu %}
                {% embed 'fiche_famille/famille_composition.html' %}
                {% endembed %}
            {% endblock %}
        {% endembed %}

        {# Rubriques #}
{% comment %}
        {% embed 'core/box.html' %}
            {% block box_theme %}card-outline card-lightblue{% endblock %}
            {% block box_titre %}Rubriques{% endblock %}
            {% block box_contenu %}
                {% for onglet in liste_onglets|slice:"1:" %}
                    <a class="btn btn-app" href="{% url onglet.url idfamille=famille.idfamille %}" style="font-size: 12px !important;">
                        <i class="fa {{ onglet.icone }}"></i> {{ onglet.label }}
                    </a>
                {% endfor %}
            {% endblock %}
        {% endembed %}
{% endcomment %}

        {# Widgets informations #}
        <div class="row">

            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-{% if solde > 0 %}red{% else %}gray-light{% endif %}"><i class="fa fa-euro"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Solde</span>
                        <span class="info-box-number {% if solde > 0 %}text-red{% endif %}">{{ solde|montant }}</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3" title="{{ hover_message }}">
                <div class="info-box">
                    <span class="info-box-icon bg-{% if nbre_alertes %}orange{% else %}gray-light{% endif %}"><i class="fa fa-warning"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Alertes</span>
                        <div class="info-box-content-inline">
                          <span class="info-box-number">{{ nbre_alertes }}</span>
                          <span class="info-box-small-text">Survolez pour voir les alertes</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-{% if notes|length %}orange{% else %}gray-light{% endif %}"><i class="fa fa-sticky-note-o"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Notes</span>
                        <span class="info-box-number">{{ notes|length }}</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-{% if nbre_messages_non_lus %}orange{% else %}gray-light{% endif %}"><i class="fa fa-comments-o"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Messages</span>
                        <span class="info-box-number">{{ nbre_messages_non_lus }}</span>
                    </div>
                </div>
            </div>

        </div>

{% load i18n %}

        {# Bloc solde des prestations #}

        {% if solde_famille < 0 %}
            <div class="alert alert-success">
                <i class="fa fa-check-circle margin-r-5"></i>
                {% blocktrans %}Il reste un crédit de{% endblocktrans %}
                <b>{{ solde_famille|inverse_signe|montant }}</b>
            </div>

        {% elif liste_prestations_solde %}
            {% embed 'core/box.html' with box_titre=True %}
                {% block box_theme %}card-outline card-danger{% endblock %}
                {% block box_titre %}{% trans "Détail des soldes des différentes prestations" %}{% endblock %}
                {% block card_body_classe %}p-0{% endblock %}
                {% block box_contenu %}

                    <table class="table-facturation table mb-0">
                        <thead>
                            <tr>
                                <th>{% trans "Activité" %}</th>
                                <th>{% trans "Intitulé" %}</th>
                                <th>{% trans "Montant" %}</th>
                                <th>{% trans "Déjà réglé" %}</th>
                                <th>{% trans "Reste à régler" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prestation in liste_prestations_solde %}
                                <tr>
                                    <td>({{ prestation.date_valeur|date:"Y" }}) {{ prestation.activite.nom }} ({{ prestation.individu.prenom }})</td>
                                    <td>{{ prestation.label }}</td>
                                    <td>{{ prestation.montant_total|montant }}</td>
                                    <td>{{ prestation.montant_regle|montant }}</td>
                                    <td>
                                        {% if prestation.montant_restant > 0 %}
                                            <span class="badge-pill bg-danger">
                                                {{ prestation.montant_restant|montant }}
                                            </span>
                                        {% else %}
                                            <span class="text-success">
                                                {{ prestation.montant_restant|inverse_signe|montant }}
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                {% endblock %}
            {% endembed %}

        {% else %}
            <div class="alert alert-success">
                <i class="fa fa-check-circle margin-r-5"></i>
                {% trans "Votre compte est à jour. Aucune somme n’est à régler." %}
            </div>
        {% endif %}



        {# Alertes #}
        {% if nbre_alertes %}
            {% embed 'core/box.html' %}
                {% block box_theme %}box-warning{% endblock %}
                {% block box_titre %}Alertes{% endblock %}
                {% block box_contenu %}

                    {# Pièces à fournir manquantes #}
                    {% if pieces_fournir %}
                        {% embed "individus/alerte.html" with items=pieces_fournir titre="Pièces à fournir manquantes"%}{% endembed %}
                    {% endif %}

                    {# Cotisations manquantes #}
                    {% if cotisations_manquantes %}
                        {% embed "individus/alerte.html" with items=cotisations_manquantes titre="Adhésions manquantes"%}{% endembed %}
                    {% endif %}

                {% endblock %}
            {% endembed %}
        {% endif %}

        {# Notes #}
        {% embed 'core/box.html' %}
            {% block box_theme %}card-outline card-lightblue{% endblock %}
            {% block box_titre %}Notes{% endblock %}
            {% block box_outils %}
                <a type="button" class="btn btn-success btn-xs" style="margin-right: 10px;" title="Ajouter une note" href="{% url 'famille_notes_ajouter' idfamille=famille.idfamille %}"><i class="fa fa-plus"></i> Ajouter</a>
            {% endblock %}
            {% block card_body_classe %}p-0{% endblock %}
            {% block box_contenu %}
                    {% embed "outils/notes.html" with mode_notes='famille' %}
                    {% endembed %}
            {% endblock %}
        {% endembed %}

    </div>
{% endblock %}
